openapi: 3.0.3
info:
  title: Leads CRM Webhook
  description: |
    Este webhook envia **leads qualificados** para o CRM do cliente.  
    O cliente deve disponibilizar um endpoint HTTP que aceite **requisições POST em JSON**.  
    Cada requisição conterá os dados do lead, do imóvel e do contexto da negociação.  

    É necessário configurar autenticação via **Bearer Token** para garantir a segurança do envio.  
  version: "1.0.0"
servers:
  - url: https://crm-cliente.com/api/webhook-leads
    description: |
      URL de exemplo fornecida pelo cliente.  
      Substitua pelo domínio real onde o CRM aceitará as requisições de leads.
paths:
  /crm/webhook:
    post:
      summary: Receber lead qualificado
      description: |
        Este endpoint será chamado pelo webhook sempre que um novo lead for gerado.  
        O corpo da requisição contém todos os dados relevantes sobre o lead e o imóvel.  
      
        O CRM deve:
        - Validar o **Bearer Token** presente no header `Authorization`.
        - Processar e armazenar os dados recebidos.
        - Responder com o **código HTTP adequado**:
          - **201 Created** → quando o lead for salvo com sucesso.
          - **400 Bad Request** → quando os dados recebidos forem inválidos ou estiverem fora do formato esperado.
          - **401 Unauthorized** → quando o Bearer Token estiver ausente ou incorreto.
          - **500 Internal Server Error** → em caso de erro inesperado no CRM.
        - Caso o CRM não suporte múltiplos códigos HTTP, pode responder sempre com **200 OK**, 
          mas deve indicar no corpo da resposta se foi sucesso ou erro (campo `success: true/false`).
      security:
        - bearerAuth: []
      requestBody:
        required: true
        description: Objeto JSON com os dados completos do lead.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Lead'
            example:
              id: "69a7db2d-c07d-4705-99b4-160020faace8"
              name: "João Silva"
              cpf: "12345678900"
              email: "joao.silva@email.com"
              cell_phone: "11999888777"
              profile: "search_prop"
              prop_id: "123"
              prop_link: "https://site.com/imovel/AP1234"
              prop_type: "Casa"
              prop_purpose: "Residencial"
              location: "São Paulo - Vila Mariana"
              transaction_type: ["Venda"]
              budget: [200000, 400000]
              acquisition_timeframe: "3-6 months"
              summary: "Cliente busca imóvel para investimento"
              conversation_link: "https://app.com/chat/123"
              visit_scheduled_dates: ["2025-09-04T10:00:00Z"]
              dates: ["2025-09-10T15:30:00Z"]
              sent_by: "lais"
              created_at: "2025-09-04T14:21:00Z"
      responses:
        "201":
          description: |
            Lead recebido e processado com sucesso pelo CRM.  
            O CRM deve responder com **201 Created** quando conseguir salvar o lead corretamente.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                success: true
                message: "Lead successfully received"
      
        "400":
          description: |
            Erro de validação ou dados inválidos.  
            O CRM deve responder com **400 Bad Request** quando o payload não estiver no formato esperado.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Erro de validação"
                errors:
                  email: ["Formato inválido"]
      
        "401":
          description: |
            Erro de autenticação.  
            O CRM deve responder com **401 Unauthorized** quando o Bearer Token estiver ausente ou inválido.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Token inválido ou ausente"
      
        "500":
          description: |
            Erro interno no CRM.  
            O CRM deve responder com **500 Internal Server Error** quando ocorrer uma falha inesperada no processamento.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Erro interno ao salvar lead"
      
        "200":
          description: |
            ⚠️ **Fallback apenas para CRMs limitados** que não permitem múltiplos códigos HTTP.  
            Nesses casos, o CRM deve sempre responder **200 OK**, mas indicar no corpo da resposta se houve sucesso ou erro.
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - $ref: '#/components/schemas/ErrorResponse'
              examples:
                sucesso:
                  summary: Exemplo de sucesso
                  value:
                    success: true
                    message: "Lead successfully received"
                erro:
                  summary: Exemplo de erro
                  value:
                    success: false
                    message: "Erro ao salvar lead"
                    errors:
                      email: ["Formato inválido"]


components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Autenticação baseada em **Bearer Token**.  
        Cada requisição enviada pelo webhook terá um header:
        ```
        Authorization: Bearer {TOKEN_SECRETO}
        ```

  schemas:
    Lead:
      type: object
      description: Estrutura de dados enviada no corpo da requisição para representar o lead.
      properties:
        id:
          type: string
          format: uuid
          description: Identificador único do lead.
        name:
          type: string
          description: Nome completo do lead.
        cpf:
          type: string
          description: CPF do lead (quando informado).
        email:
          type: string
          description: Endereço de e-mail do lead.
        cell_phone:
          type: string
          description: Telefone/celular do lead.
        profile:
          type: string
          description: |
            Perfil do lead:  
            - `search_prop`: busca imóvel para compra/locação  
            - `investiment_prop`: busca para investimento  
            - `owner_prop`: proprietário interessado em vender/alugar
          enum: [search_prop, investiment_prop, owner_prop]
        prop_id:
          type: string
          description: Identificador interno do imóvel.
        prop_link:
          type: string
          format: uri
          description: Link público do imóvel.
        prop_type:
          type: string
          description: Tipo do imóvel (apartment, house, commercial).
        prop_purpose:
          type: string
          description: Finalidade do imóvel (residential, commercial, etc).
        location:
          type: string
          description: Localização textual do imóvel (bairro/cidade).
        transaction_type:
          type: array
          description: Tipos de transação desejados.
          items:
            type: string
            enum: [Venda, Locacao]
        budget:
          type: array
          description: Faixa de orçamento [mínimo, máximo].
          items:
            type: number
          minItems: 2
          maxItems: 2
        acquisition_timeframe:
          type: string
          description: Prazo estimado para aquisição.
        summary:
          type: string
          description: Resumo da conversa com o lead.
        conversation_link:
          type: string
          format: uri
          description: Link para histórico completo da conversa.
        visit_scheduled_dates:
          type: array
          description: Datas agendadas para visita ao imóvel.
          items:
            type: string
            format: date-time
        dates:
          type: array
          description: Outras datas relevantes associadas ao lead.
          items:
            type: string
            format: date-time
        sent_by:
          type: string
          description: Sistema ou usuário que enviou o lead.
        created_at:
          type: string
          format: date-time
          description: Data e hora de criação do lead no sistema (UTC).
      required: [id, name, cell_phone, created_at]

    SuccessResponse:
      type: object
      description: Estrutura retornada quando o CRM processa o lead com sucesso.
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Lead successfully received

    ErrorResponse:
      type: object
      description: Estrutura retornada quando ocorre erro no processamento do lead.
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: Error processing lead
        errors:
          type: object
          description: Lista de erros de validação por campo.
          additionalProperties:
            type: array
            items:
              type: string
